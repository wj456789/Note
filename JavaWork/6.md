# Note



## Linux

### grep 

查找文件里符合条件的字符串 

```sh
grep [-abcEFGhHilLnqrsvVwxy][-A<显示行数>][-B<显示列数>][-C<显示列数>][-d<进行动作>][-e<范本样式>][-f<范本文件>][--help][范本样式][文件或目录...]
```

```sh
# 查找前缀有“test”的文件包含“test”字符串的文件，-n 标示出该行的列数编号。
$ grep -n test test*

# 以递归的方式查找符合条件的文件。例如，查找指定目录/etc/acpi 及其子目录（如果存在子目录的话）下所有文件中包含字符串"update"的文件，并打印出该字符串所在行的内容
$ grep -r update /etc/acpi

# 反向查找，通过"-v"参数可以打印出不符合条件行的内容
# 查找文件名中包含 test 的文件中不包含test 的行
$ grep -v test *test*
```

### 删除

```sh
# 删除当前test文件夹下 所有目录和文件名中包含keep字符串 之外的所有文件目录
$ find  ./test/  |  grep  -v  keep  |  xargs  rm  -rf
```



## 下载

```java
String path = uploadDocumentPath + System.getProperty("file.separator") + documentName;
File file = UsFileUtils.getFile(path);
if (!file.exists()) {
    throw new BusinessException("failed");
} else {
    if (!UsFileLiteUtils.isSecurityFileName(file.getCanonicalPath())) {
        throw new BusinessException("failed");
    }
    
    response.setContentType("application/force-download");
    // setFileDownloadHeader(request, resp, fileName, fileType);
    
    byte[] buffer = new byte[1024];
    try(FileInputStream fis = FileUtils.openInputStream(file);
        BufferedInputStream bis = new BufferedInputStream(fis);) {
        OutputStream os = response.getOutputStream();
        int i = 0;
        while ((i=bis.read(buffer)) != -1) {
            os.write(buffer, 0, i);
        }
    } catch (IOException e) {
        LOGGER.error("IOException error: ", e);
    }
}



private static final String MSIE = "msie";
private static final String GECKO = "like gecko";
private static final String MOZILLA = "Mozilla";
// 解决中文名称
public static void setFileDownloadHeader(
    HttpServletRequest request, HttpServletResponse response, String fileName, String fileType) {
    try {
        String encodedfileName = null;
        String agent = NormalizerUtil.normalizeForString(request.getHeader("user-agent").toLowerCase(Locale.US));
        if (agent.contains(MOZILLA)) {
            encodedfileName = new String(fileName.getBytes("UTF-8"), "iso-8859-1");
        } else {
            encodedfileName = java.net.URLEncoder.encode(fileName, "UTF-8");
        }
        response.reset();
        // 设置响应的头文件，会自动识别文件内容
        response.setContentType("application/x-msdownload");
        // 设置Content-Disposition
        String contentDisposition=String.format(Locale.ENGLISH, "attachment; filename=\"%s\"", (encodedfileName + fileType).replaceAll("\t|\r|\n", ""));
        response.setHeader("Content-disposition", contentDisposition);
        response.setHeader("Pragma", "no-cache");
        response.setHeader("Cache-Control", "no-cache, no-store");
    } catch (UnsupportedEncodingException e) {
        logger.error("Throw exception message here: " + e);
    }
}
```



## JS

### 动态添加

#### 案例一

```html
<div id="OuterDiv_C" style="position:absolute;top:9%;left:47%;width:15%;height:15%;">
    <div id="InterDiv_C">
        <p id="FontStyle1"><span id="sp0_C" style="float:left;margin-top:8px;margin-left:15px;line-height: 11px;color:#41beff;"></span></p>
        <img id="img1" src="images/iopImages/showMore.png" class="img" style="float:right;margin-top:12px;margin-right:8px;" />
    </div>
    <div id="ContentDiv_C" style="width:150px;margin-left: 0px;margin-top: 2px; display: none;">
    </div>
</div>
```

```javascript
$scope.initContentData = function ($Model, type) {
    $Fire({
        'service' : "queryIndexService/getContentInfo",
        'target' : '$Model.contentInfo'
    }, this).onafter(function(){
        $("#sp0_C").text($Model.contentInfo.defaultContent);
        if($Model.contentInfo.timeContents){
            for(var i=0;i<$Model.contentInfo.timeContents.length;i++){
                var timeContent = $Model.contentInfo.timeContents[i];
                if(timeContent == "累计12个月"){
                    $("#ContentDiv_C").append('<div id="Content2Div_C">\n' +
                                              '<img src="images/iopImages/top-partingLine.png" style="width:150px"/>\n' +
                                              '<p id="FontStyle1" style="margin-top:7px;margin-left:15px;color:#666666;font-size:16px;">\n' +
                                              '<span id="sp2_C">累计12个月</span>\n' +
                                              '</p>\n' +
                                              '</div>');
                }else {
                    $("#ContentDiv_C").append('<div id="ContentDiv'+timeContent+'">\n' +
                                              '<img src="images/iopImages/top-partingLine.png" style="width:150px"/>\n' +
                                              '<p id="FontStyle1" style="margin-top:8px;margin-left:15px;color:#666666;font-size:16px;"><span id="sp'+timeContent+'" >'+timeContent+'</span>\n' +
                                              '</p>\n' +
                                              '</div>');
                }
            }
            $('#ContentDiv_C').css("height",$Model.contentInfo.timeContents.length*36+10+'px');
            $('#ContentDiv_C').on('mouseover','div',function(){
                $(this).css("font-weight","bold");
            });
            $('#ContentDiv_C').on('mouseout','div',function(){
                $(this).css("font-weight","normal");
            });
            $('#ContentDiv_C').on('click','div',function(){
                $scope.queryByCondition($Model,$(this).children("p").children("span").text())
            });
            $scope.queryByCondition($Model,$Model.contentInfo.defaultContent)
            $('#ContentDiv_C').css('display','none');
        }
    });
}
```

#### 案例二

```html
<div id="bottombox">
    <div style="position:absolute;top:74%;right:15%;width:50%;height:2%;z-index:999" class="font14">
        <div id="click1" class="click1 clickable">
            <img id="clickCricle1" alt="" src="images/iopImages/circle_selected.png" class="circlePosition">
            <span id="clickspan1">title1</span>
            <uee:fire event="click" script="clickActCricle($Model,'click1')"></uee:fire>
        </div>
    </div>
</div>
```

```javascript
$scope.clickByCondition = function($Model,type,content){

    $('#sp0_C').text(content);

    $('#ContentDiv_C').slideToggle(300);
    $('#clickCricle1').remove();

    $("#clickspan1").before('<img id="clickCricle1" alt="" src="images/iopImages/circle_selected.png" class="circlePosition">');
}
```

参考：

[jQuery-为动态添加的元素绑定事件](https://blog.csdn.net/xiaozhi_2016/article/details/52184328)

[js为动态添加的元素增加事件（事件委托）](https://blog.csdn.net/badmoonc/article/details/78259219)

### img

`div`只包含一个`img`元素，但是页面展示上`div`却比`img`高出一点 

```html
<!-- html部分 -->
<div class="header-pic">
    <img class="" :src='headPic' />
    <div class="linear-bg"></div>
</div>
```

```javascript
//less代码
.header-pic {
    position: relative;
    border-radius: 10px 10px 0px 0px;
    width: 100%;

    img {
        width: 100%;
        background-size: cover;
    }
    .linear-bg {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        height: 100%;
        background: rgba(51,51,51,0.10);
    }
}
```

**问题原因**

> 后来查了一下资料，发现`img`元素后面会跟一个空白符，会使它的高度多出3px
> 至于为什么img元素后面会出现3px的空白呢～？因为`img`元素是行内元素，行内元素默认会有3px的间距。因此当我们的块级元素`div`包含这个行内元素的时候底部就出现了3px的间距。

**解决方案**

> 设置`img`为`display:block`,空白就消失，因为将img元素设置为块级元素，就不会存在默认间距了。

### JQuery

**获取当前标签下的子标签**

1、查找子元素方式1：>
例如：var aNods = $(“ul > a”);查找ul下的所有a标签

2、查找子元素方式2：children()

3、查找子元素方式3：find()

通过下标获取第n个子标签的ID值
1.var num1=$(“ul > a:eq(0)”).attr(“ID”);

2.var num2=$(“ul”).children(“a:eq(0)”).attr(“ID”);

3.var num3=$(“ul”).find(“a:eq(0)”).attr(“ID”);

## SSO

### 流程说明

#### 登录

合法用户首次进入系统：

用户	浏览器			业务子系统				   SSO Server

用户 -> 浏览器(TGC) -> SSO Client(Session)和业务系统 -> SSO Server

1. 用户向浏览器发送请求
2. 浏览器向SSO Client发送请求，SSO_CLIENT过滤出未认证的用户，也就是无法通过Session识别用户，则SSO Client重定向（携带SSO_Server的登录url和用户访问业务的URL）浏览器请求到SSO Server；
   - 其中Session存在如下几种情况：1）用户请求中无SessionID； 2）用户请求中有SessionID，但无SSO_Client的数据（Assertion）；
   - （**已经登录的用户再次进入业务系统**）-> 如果SSO_Client可以从session的得到Assertion数据，认为用户已经登录了，直接将业务请求提交到业务系统第九步。
3. SSO_Server发现该用户没有携带TGC，向用户响应登录页面；
   - （**已经登录的用户进入新的业务系统**）-> 如果浏览器发起的认证请求中携带了TGC，SSO_Server根据TGC关联到用户，根据TGC找到对应的TGT（ST和业务URL纪录在TGT中），判断TGT没有超期，认为用户合法，重定向浏览器到SSO Client并返回一个ST（serive ticket）给浏览器，直接到第六步。
4. 用户在浏览器上输入登录信息，提交到SSO Server。
5. SSO_Server完成认证，根据用户数据生成本次登录的TGT，向浏览器响应，返回该业务的ST和TGC（TGC的值就是TGT的ID），并重定向浏览器请求到SSO Client
6. 浏览器以**cookies的方式记录TGC**，携带ST重定向到SSO Client
7. SSO_Client发现用户请求中包含ticket信息，向SSO Server发起ST票据验证请求。 
8. SSO_Server验证票据是否为认证时为该业务分配的票据，并返回数据给客户端（将TGT中的保存的Assertion返回给client）。
   - 票据验证成功正确，返回用户数据
   - 票据非法，则本次业务认证失败
9. **SSO_Client将用户数据写入Session**中，供业务使用，并将请求提交到业务中，提交方式根据配置有两种：
   - 直接将本次请求提交给业务。
   - 通过rediect方式提交：该方式可以保证sessionid在进入业务之前写入浏览器



**SSO_Server实现单点登录的原理**

根据浏览器携带的TGC判断用户是否登录，如果登录直接放行。否则，呈现登录界面。

浏览器没有TGC，浏览器填写用户到Server认证生成TGC和ST返回给浏览器，有TGC直接返回ST给浏览器

之后始终浏览器获取ticket发送到client再到server认证

**SSO_Client实现单点登录的原理**

根据session判断用户是否登录，如果登录放行，否则，跳转到sso_server。

#### 登出

1. 用户点击业务界面的登出按钮
2. 浏览器向SSO_Server发出登录请求：浏览器会自动携带TGC信息，发起登出请求
3. SSO_Server处理登出请求
   1. 根据TGC找到对应的TGT，从TGT中得到改用户已经登录的所有业务的信息。
   2. 向业务的URL（实际上是SSO Client）发起请求，携带登出logout参数，该参数的中包含登录时分配的ST信息
4. SSO_Client根据消息中携带的logout标识，判断是一个登出请求，注销用户的session，并返回。
   1. SSO_Client判断请求中携带了“logoutRequest”（协议参数）。则认为是一个登出处理。
   2. 根据消息中携带的ST的值，查找出对应的session，将session注销掉。
5. SSO_Server向用户呈现登出界面，并清除TGC，具体的登出界面，在SSO_Server侧根据配置实现。



**TGC:**和一个具有一定有效期的身份证号码相似。

- 是SSO_Server和浏览器之间使用的一个cookies的值，该只在server侧可以唯一标识一个用户。在格式上是一个散列码，能有效防止伪造和攻击。其值的形式如下：TGT-1-w7uJd4E71MeiycjYZCS0KJgvyOwyNm6A0q05Fk1eUmbMjn0OMY-cas
- 根据cookies的协议，TGC只能在SSO_Server和浏览器之间使用。正规的浏览器不能将该TGC传递给sso_client
- TGC对应的数据(TGT)只在Server侧有效，sso_client无法解析TGC的含义

**TGT(Ticket Granting Ticket)**：再服务器侧管理的用户相关的数据，和公安局中管理的用户的户口及档案信息相似。

- TGT的ID为TGC:可以保证由TGC能快速的检索到对应的TGT
- TGT中保存有：
  - 需要返回给业务侧的用户数据：assertion
  - 用户已经等了的业务URL及ST
  - Cookies有效期的有关数据。
- TGT不会给浏览器呈现，可以保证数据安全
- TGT的有效期到期之后，系统会主动注销TGT，保证安全性
- TGT注销之前，会给sso_client发送登出请求



## http

```java
private String getRealIpAttr(HttpServletRequest request) {
    String ip = request.getHeader("x-forwarded-for");
    if (StringUtils.isNotBlank(ip) && ip.contains(",")) {
        ip = ip.split(",")[0];
    }
    if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
        ip = request.getHeader("Proxy-Client-IP");
    }
    if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
        ip = request.getHeader("WL-Proxy-Client-IP");
    }
    if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
        ip = request.getRemoteAddr();
    }
    return ip.equals("0:0:0:0:0:0:0:1") ? "127.0.0.1" : ip;
}
```

[httpServletRequest获取客户端真实ip](https://blog.csdn.net/u014410695/article/details/50162315)

## Gauss

```sql
> su - gtsgsdba -s /bin/bash
> cd app/bin
> zsql / as sysdba -q 
-- > zsql metadb/ABC_abc1@7.220.29.236:15432 -q 使用其他用户登录
> EXP USERS=METADB FILE="/opt/backup/gdbservice/data/metadb_back_20221024.dmp";
> EXP USERS=SERVICEDB FILETYPE=BIN FILE="/opt/backup/gdbservice/data/servicedb_back_20221024.dmp";
-- 其中，斜体部分可根据实际情况配置。
-- /bin/bash和app/bin以现场实际路径为准。
```

- FILETYPE=BIN时，会导出三类文件：元数据文件（用户指定的文件）、数据文件（.D文件）和LOB文件（.L文件）。 

  逻辑导出数据时，会在指定的导出文件路径下生成一个元数据文件和一个名为data的子目录，如果未指定导出文件路径，则默认在当前路径下生成一个元数据文件和一个名为data的子目录。FILETYPE=BIN时，生成的子文件（数据文件、LOB文件）会放在二级目录data下，如果指定的元数据文件和生成的子文件已经存在，则会报错。

- 导出当前用户的tab1和tab2中的数据。`EXP TABLES=tab1,tab2  FILE="file1.dmp";`

```sql
> IMP USERS=SERVICEDB FILETYPE=BIN FILE="/opt/backup/gdbservice/data/servicedb_back_20221024.dmp";
```

### other

#### 删除用户时，用户已登录，删除失败

```sql
SQL> DROP USER IF EXISTS BILLDB CASCADE;
GS-00807, The user BILLDB has logged in, can not be dropped now
```

解决方案： 删除已连接的session，再删除该用户。 

```sql
# 查看已连接的 SESSION
SQL> SELECT SID, SERIAL#, CLIENT_IP, PROGRAM FROM DV_SESSIONS WHERE USERNAME='BILLDB';
SID          SERIAL#      CLIENT_IP
------------ ------------ ----------------------------------------------------------------
280          13495        10.189.105.41
353          9141         10.189.105.41
538          6701         10.189.105.41
3 rows fetched.
 
# 删除 SESSION
SQL> ALTER SYSTEM KILL SESSION '280,13495';
Succeed.
 
SQL> ALTER SYSTEM KILL SESSION '353,9141';
Succeed.
 
SQL> ALTER SYSTEM KILL SESSION '538,6701';
Succeed.
 
# 再次查看已连接的 SESSION
SQL> SELECT SID, SERIAL#, CLIENT_IP FROM DV_SESSIONS WHERE USERNAME='USER_TEST';
SID          SERIAL#      CLIENT_IP
------------ ------------ ----------------------------------------------------------------
0 rows fetched.
 
# 删除用户
SQL> DROP USER IF EXISTS BILLDB CASCADE;
Succeed.
```



## Mybatis

### 批量插入

mybatis 设置 batch 模式和批量 foreach 插入 

[Mybatis 批量插入数据的三种方式](https://blog.csdn.net/chang100111/article/details/115664432)

[springboot 集成的 mybatis 设置 executorType 为 batch模式](https://blog.csdn.net/gzt19881123/article/details/122815596)

### 动态SQL

#### if

```xml
<select id="findActiveBlogLike"
     resultType="Blog">
  SELECT * FROM BLOG WHERE state = ‘ACTIVE’
  <if test="title != null">
    AND title like #{title}
  </if>
  <if test="author != null and author.name != null">
    AND author_name like #{author.name}
  </if>
</select>
```

#### choose、when、otherwise

从多个条件中选择一个使用 

```xml
<!-- 传入了 “title” 就按 “title” 查找，传入了 “author” 就按 “author” 查找的情形。若两者都没有传入，就返回标记为 featured 的 BLOG -->
<select id="findActiveBlogLike"
     resultType="Blog">
  SELECT * FROM BLOG WHERE state = ‘ACTIVE’
  <choose>
    <when test="title != null">
      AND title like #{title}
    </when>
    <when test="author != null and author.name != null">
      AND author_name like #{author.name}
    </when>
    <otherwise>
      AND featured = 1
    </otherwise>
  </choose>
</select>
```

#### trim、where、set

##### where

*where* 元素只会在子元素返回任何内容的情况下才插入 “WHERE” 子句。而且，若子句的开头为 “AND” 或 “OR”，*where* 元素也会将它们去除。 

```xml
<select id="findActiveBlogLike"
     resultType="Blog">
  SELECT * FROM BLOG
  <where>
    <if test="state != null">
         state = #{state}
    </if>
    <if test="title != null">
        AND title like #{title}
    </if>
    <if test="author != null and author.name != null">
        AND author_name like #{author.name}
    </if>
  </where>
</select>
```



```xml
<!-- prefixOverrides 属性会忽略通过管道符分隔的文本序列（注意此例中的空格是必要的）。例子会移除所有 prefixOverrides 属性中指定的内容，并且插入 prefix 属性中指定的内容。 这里自定义 trim 元素和 where 元素是等价的-->
<trim prefix="WHERE" prefixOverrides="AND |OR ">
  ...
</trim>
```



##### set

```xml
<!-- set 元素可以用于动态包含需要更新的列，忽略其它不更新的列，set 元素会动态地在行首插入 SET 关键字，并会删掉额外的逗号 -->
<update id="updateAuthorIfNecessary">
  update Author
    <set>
      <if test="username != null">username=#{username},</if>
      <if test="password != null">password=#{password},</if>
      <if test="email != null">email=#{email},</if>
      <if test="bio != null">bio=#{bio}</if>
    </set>
  where id=#{id}
</update>
```

```xml
<!-- 和上述set元素等价 -->
<trim prefix="SET" suffixOverrides=",">
  ...
</trim>
```

#### foreach

对集合进行遍历 

```xml
<!-- 指定一个集合（collection），声明可以在元素体内使用的集合项（item）和索引（index）变量。也允许指定开头与结尾的字符串以及集合项迭代之间的分隔符。这个元素也不会错误地添加多余的分隔符 -->
<select id="selectPostIn" resultType="domain.blog.Post">
  SELECT *
  FROM POST P
  <where>
    <foreach item="item" index="index" collection="list"
        open="ID in (" separator="," close=")" nullable="true">
          #{item}
    </foreach>
  </where>
</select>
```

可以将任何可迭代对象（如 List、Set 等）、Map 对象或者数组对象作为集合参数传递给 *foreach*。当使用可迭代对象或者数组时，index 是当前迭代的序号，item 的值是本次迭代获取到的元素。当使用 Map 对象（或者 Map.Entry 对象的集合）时，index 是键，item 是值。 

#### script

要在带注解的映射器接口类中使用动态 SQL，可以使用 *script* 元素。比如: 

```java
    @Update({"<script>",
      "update Author",
      "  <set>",
      "    <if test='username != null'>username=#{username},</if>",
      "    <if test='password != null'>password=#{password},</if>",
      "    <if test='email != null'>email=#{email},</if>",
      "    <if test='bio != null'>bio=#{bio}</if>",
      "  </set>",
      "where id=#{id}",
      "</script>"})
    void updateAuthorValues(Author author);
```

#### bind

`bind` 元素允许你在 OGNL 表达式以外创建一个变量，并将其绑定到当前的上下文。比如： 

```xml
<select id="selectBlogsLike" resultType="Blog">
  <bind name="pattern" value="'%' + _parameter.getTitle() + '%'" />
  SELECT * FROM BLOG
  WHERE title LIKE #{pattern}
</select>
```

#### 多数据库支持

如果配置了 databaseIdProvider，你就可以在动态代码中使用名为 “_databaseId” 的变量来为不同的数据库构建特定的语句。比如下面的例子： 

```xml
<insert id="insert">
  <selectKey keyProperty="id" resultType="int" order="BEFORE">
    <if test="_databaseId == 'oracle'">
      select seq_users.nextval from dual
    </if>
    <if test="_databaseId == 'db2'">
      select nextval for seq_users from sysibm.sysdummy1"
    </if>
  </selectKey>
  insert into users values (#{id}, #{name})
</insert>
```

#### 动态 SQL 中的插入脚本语言

MyBatis 从 3.2 版本开始支持插入脚本语言，这允许你插入一种语言驱动，并基于这种语言来编写动态 SQL 查询语句。

可以通过实现以下接口来插入一种语言：

```java
public interface LanguageDriver {
  ParameterHandler createParameterHandler(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql);
  SqlSource createSqlSource(Configuration configuration, XNode script, Class<?> parameterType);
  SqlSource createSqlSource(Configuration configuration, String script, Class<?> parameterType);
}
```

实现自定义语言驱动后，你就可以在 mybatis-config.xml 文件中将它设置为默认语言： 

```xml
<typeAliases>
  <typeAlias type="org.sample.MyLanguageDriver" alias="myLanguage"/>
</typeAliases>
<settings>
  <setting name="defaultScriptingLanguage" value="myLanguage"/>
</settings>
```

或者，你也可以使用 `lang` 属性为特定的语句指定语言： 

```xml
<select id="selectBlog" lang="myLanguage">
  SELECT * FROM BLOG
</select>
```

或者，在你的 mapper 接口上添加 `@Lang` 注解： 

```java
public interface Mapper {
  @Lang(MyLanguageDriver.class)
  @Select("SELECT * FROM BLOG")
  List<Blog> selectBlog();
}
```

[mybatis](https://mybatis.org/mybatis-3/zh/dynamic-sql.html)



### 函数

```sql
CREATE OR REPLACE FUNCTION GETCHILDRENCATALOG ( rootid varchar2,tablename varchar2) RETURN varchar2
AS 
	schildrentemp varchar2 ( 4000 ):=rootid;
	schildrenlist varchar2 ( 8000 );
BEGIN
	while
	schildrentemp is not NULL  LOOP
	if ( schildrenlist is not null ) then
			 schildrenlist := concat( schildrenlist, ',', schildrentemp );
	else 
			 schildrenlist := concat( schildrentemp );
	end if;
	if ( tablename = 'DATA_CATALOG' ) then
			select
				group_concat( catalog_id ) into schildrentemp 
			from
				(SELECT catalog_id,parent_catalog_id from DATA_CATALOG
                 UNION
                 select BUSINESSOBJECT_ID catalog_id,catalog_id parent_catalog_id from BUSINESS_OBJECT_INFO
                ) 
			where
				find_in_set( parent_catalog_id, schildrentemp ) > 0;
	elsif ( tablename = 'METRICS_CATALOG') then
			select
				group_concat( metrics_catalog_id ) into schildrentemp 
			from
				metrics_catalog 
			where
				find_in_set( parent_metrics_catalog_id, schildrentemp ) > 0;
	elsif ( tablename = 'DATAPRODUCT_CATALOG') then
			select
				group_concat( dataProduct_catalog_id ) into schildrentemp 
			from
				dataProduct_catalog 
			where
				find_in_set( parent_dataProduct_catalog_id, schildrentemp ) > 0;
	elsif ( tablename = 'TABLE_DEPENDENCE_INFO' ) then
			select
				group_concat( schema_table ) into schildrentemp 
			from
				table_dependence_info 
			where
				find_in_set( dependent_id, schildrentemp ) > 0;
	elsif ( tablename = 'CUSTOMERLABEL_CATALOG') then
			select
				group_concat( customerlabel_catalog_id ) into schildrentemp 
			from
				customerlabel_catalog 
			where
				find_in_set( parent_customerlabel_catalog_id, schildrentemp ) > 0;
	end if;
	end LOOP;
	return schildrenlist;
end;/
```



```xml
<!-- select GETCHILDRENCATALOG('0','BUSINESS_CATALOG') -->
<select id="getCategoryRelationship" resultMap="BusinessCatalog"
        resultType="com.huawei.business.model.BusinessCatalog" databaseId="mysql">
    SELECT BC.BUSI_CATALOG_ID,
    BC.BUSI_CATALOG_NAME_CN,
    BC.BUSI_CATALOG_NAME_EN,
    BC.BUSI_CATALOG_DESC,
    BC.PARENT_BUSI_CATALOG_ID,
    BC.BUSI_CATALOG_SORT,
    BC.CREATE_BY,
    BC.CREATE_DATE,
    BC.STATE,
    BC.STATE_DATE,
    (select GETUPLEVEL(BC.BUSI_CATALOG_ID,'BUSINESS_CATALOG')) LEVEL,
    (select GETISLEAF(BC.BUSI_CATALOG_ID,'BUSINESS_CATALOG')) AS isLeaf
    FROM BUSINESS_CATALOG BC
    WHERE STATE='2'
    AND    FIND_IN_SET(BC.BUSI_CATALOG_ID,(select GETCHILDRENCATALOG('0','BUSINESS_CATALOG')))>0
</select>
```

```xml
<!-- getChildrenCatalog??? -->
<select id="getChildrenCatalog" resultType="java.lang.String">
    SELECT "GETCHILDRENCATALOG"
    (
    #{catalogId,jdbcType=VARCHAR},
    'DATA_CATALOG'
    )
    as "GETCHILDRENCATALOG" FROM DUAL
</select>



<select id="getBusiChildsCatalog" resultMap="BusiBaseResultMap" parameterType="String">
    <!-- mysql语句 -->
    SELECT DISTINCT
    BUSI_CATALOG_ID
    FROM
    (
    SELECT
    d.BUSI_CATALOG_ID,
    d.PARENT_BUSI_CATALOG_ID,
    d.BUSI_CATALOG_NAME_CN,
    d.BUSI_CATALOG_NAME_EN,
    getDownLevel(d.BUSI_CATALOG_ID,'BUSINESS_CATALOG') AS LEVEL,
    getIsLeaf(d.BUSI_CATALOG_ID,'BUSINESS_CATALOG') isleaf
    FROM
    BUSINESS_CATALOG d LEFT JOIN BUSINESS_CATALOG t
    ON d.BUSI_CATALOG_ID=t.PARENT_BUSI_CATALOG_ID
    WHERE FIND_IN_SET(d.BUSI_CATALOG_ID,getChildrenCatalog(#{busiCatalogId}, 'BUSINESS_CATALOG'))
    AND d.STATE= '2'
    ORDER BY
    LEVEL ASC
    ) T
    WHERE
    T.isleaf =1
</select>
```

[MySQL数据库之内置函数和自定义函数 function](https://www.jb51.net/article/251748.htm)



[MySQL 创建函数(Function)](https://blog.csdn.net/jssg_tzw/article/details/39694489)



### 分页

#### limit用法

[Mybatis中limit用法与分页查询](https://blog.csdn.net/qq_42901303/article/details/87456097)



#### 引入

```xml
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper</artifactId>
    <version>最新版本</version>
</dependency>
```

#### 配置

新版拦截器是 `com.github.pagehelper.PageInterceptor`。 `com.github.pagehelper.PageHelper` 现在是一个特殊的 `dialect` 实现类，是分页插件的默认实现类，提供了和以前相同的用法。 

- 在 MyBatis 配置 xml 中配置拦截器插件

  ```xml
  <!--
      plugins在配置文件中的位置必须符合要求，否则会报错，顺序如下:
      properties?, settings?,
      typeAliases?, typeHandlers?,
      objectFactory?,objectWrapperFactory?,
      plugins?,
      environments?, databaseIdProvider?, mappers?
  -->
  <plugins>
      <!-- com.github.pagehelper为PageHelper类所在包名 -->
      <plugin interceptor="com.github.pagehelper.PageInterceptor">
          <!-- 使用下面的方式配置参数，后面会有所有的参数介绍 -->
          <property name="param1" value="value1"/>
  	</plugin>
  </plugins>
  ```

- 在 Spring 配置文件中配置拦截器插件

  使用 spring 的属性配置方式，可以使用 `plugins` 属性像下面这样配置： 

  ```xml
  <bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
    <!-- 注意其他配置 -->
    <property name="plugins">
      <array>
        <bean class="com.github.pagehelper.PageInterceptor">
          <property name="properties">
            <!--使用下面的方式配置参数，一行配置一个 -->
            <value>
              params=value1
            </value>
          </property>
        </bean>
      </array>
    </property>
  </bean>
  ```

##### 参数

分页插件提供了多个可选参数，这些参数使用时，按照上面两种配置方式中的示例配置即可。

分页插件可选参数如下：

- `dialect`：默认情况下会使用 PageHelper 方式进行分页，如果想要实现自己的分页逻辑，可以实现 `Dialect`(`com.github.pagehelper.Dialect`) 接口，然后配置该属性为实现类的全限定名称。

**下面几个参数都是针对默认 dialect 情况下的参数。使用自定义 dialect 实现时，下面的参数没有任何作用。**

1. `helperDialect`：分页插件会自动检测当前的数据库链接，自动选择合适的分页方式。 你可以配置`helperDialect`属性来指定分页插件使用哪种方言。配置时，可以使用下面的缩写值：
   `oracle`,`mysql`,`mariadb`,`sqlite`,`hsqldb`,`postgresql`,`db2`,`sqlserver`,`informix`,`h2`,`sqlserver2012`,`derby`
   **特别注意：**使用 SqlServer2012 数据库时，需要手动指定为 `sqlserver2012`，否则会使用 SqlServer2005 的方式进行分页。
   你也可以实现 `AbstractHelperDialect`，然后配置该属性为实现类的全限定名称即可使用自定义的实现方法。
2. `offsetAsPageNum`：默认值为 `false`，该参数对使用 `RowBounds` 作为分页参数时有效。 当该参数设置为 `true` 时，会将 `RowBounds` 中的 `offset` 参数当成 `pageNum` 使用，可以用页码和页面大小两个参数进行分页。
3. `rowBoundsWithCount`：默认值为`false`，该参数对使用 `RowBounds` 作为分页参数时有效。 当该参数设置为`true`时，使用 `RowBounds` 分页会进行 count 查询。
4. `pageSizeZero`：默认值为 `false`，当该参数设置为 `true` 时，如果 `pageSize=0` 或者 `RowBounds.limit = 0` 就会查询出全部的结果（相当于没有执行分页查询，但是返回结果仍然是 `Page` 类型）。
5. `reasonable`：分页合理化参数，默认值为`false`。当该参数设置为 `true` 时，`pageNum<=0` 时会查询第一页， `pageNum>pages`（超过总数时），会查询最后一页。默认`false` 时，直接根据参数进行查询。
6. `params`：为了支持`startPage(Object params)`方法，增加了该参数来配置参数映射，用于从对象中根据属性名取值， 可以配置 `pageNum,pageSize,count,pageSizeZero,reasonable`，不配置映射的用默认值， 默认值为`pageNum=pageNum;pageSize=pageSize;count=countSql;reasonable=reasonable;pageSizeZero=pageSizeZero`。
7. `supportMethodsArguments`：支持通过 Mapper 接口参数来传递分页参数，默认值`false`，分页插件会从查询方法的参数值中，自动根据上面 `params` 配置的字段中取值，查找到合适的值时就会自动分页。 使用方法可以参考测试代码中的 `com.github.pagehelper.test.basic` 包下的 `ArgumentsMapTest` 和 `ArgumentsObjTest`。
8. `autoRuntimeDialect`：默认值为 `false`。设置为 `true` 时，允许在运行时根据多数据源自动识别对应方言的分页 （不支持自动选择`sqlserver2012`，只能使用`sqlserver`），用法和注意事项参考下面的**场景五**。
9. `closeConn`：默认值为 `true`。当使用运行时动态数据源或没有设置 `helperDialect` 属性自动获取数据库类型时，会自动获取一个数据库连接， 通过该属性来设置是否关闭获取的这个连接，默认`true`关闭，设置为 `false` 后，不会关闭获取的连接，这个参数的设置要根据自己选择的数据源来决定。

**重要提示：**

当 `offsetAsPageNum=false` 的时候，由于 `PageNum` 问题，`RowBounds`查询的时候 `reasonable` 会强制为 `false`。使用 `PageHelper.startPage` 方法不受影响。

##### 场景

单独看每个参数的说明可能是一件让人不爽的事情，这里列举一些可能会用到某些参数的情况。

**场景一**

如果你仍然在用类似ibatis式的命名空间调用方式，你也许会用到`rowBoundsWithCount`， 分页插件对`RowBounds`支持和 MyBatis 默认的方式是一致，默认情况下不会进行 count 查询，如果你想在分页查询时进行 count 查询， 以及使用更强大的 `PageInfo` 类，你需要设置该参数为 `true`。

**注：** `PageRowBounds` 想要查询总数也需要配置该属性为 `true`。

**场景二**

如果你仍然在用类似ibatis式的命名空间调用方式，你觉得 `RowBounds` 中的两个参数 `offset,limit` 不如 `pageNum,pageSize` 容易理解， 你可以使用 `offsetAsPageNum` 参数，将该参数设置为 `true` 后，`offset`会当成 `pageNum` 使用，`limit` 和 `pageSize` 含义相同。

**场景三**

如果觉得某个地方使用分页后，你仍然想通过控制参数查询全部的结果，你可以配置 `pageSizeZero` 为 `true`， 配置后，当 `pageSize=0` 或者 `RowBounds.limit = 0` 就会查询出全部的结果。

**场景四**

如果你分页插件使用于类似分页查看列表式的数据，如新闻列表，软件列表， 你希望用户输入的页数不在合法范围（第一页到最后一页之外）时能够正确的响应到正确的结果页面， 那么你可以配置 `reasonable` 为 `true`，这时如果 `pageNum<=0` 会查询第一页，如果 `pageNum>总页数` 会查询最后一页。

**场景五**

如果你在 Spring 中配置了动态数据源，并且连接不同类型的数据库，这时你可以配置 `autoRuntimeDialect` 为 `true`，这样在使用不同数据源时，会使用匹配的分页进行查询。 这种情况下，你还需要特别注意 `closeConn` 参数，由于获取数据源类型会获取一个数据库连接，所以需要通过这个参数来控制获取连接后，是否关闭该连接。 默认为 `true`，有些数据库连接关闭后就没法进行后续的数据库操作。而有些数据库连接不关闭就会很快由于连接数用完而导致数据库无响应。所以在使用该功能时，特别需要注意你使用的数据源是否需要关闭数据库连接。

当不使用动态数据源而只是自动获取 `helperDialect` 时，数据库连接只会获取一次，所以不需要担心占用的这一个连接是否会导致数据库出错，但是最好也根据数据源的特性选择是否关闭连接。

#### 常用方式

##### 1). RowBounds方式的调用

```java
List<Country> list = sqlSession.selectList("x.y.selectIf", null, new RowBounds(1, 10));
```

使用这种调用方式时，你可以使用RowBounds参数进行分页，这种方式侵入性最小，我们可以看到，通过RowBounds方式调用只是使用了这个参数，并没有增加其他任何内容。

分页插件检测到使用了RowBounds参数时，就会对该查询进行**物理分页**。

关于这种方式的调用，有两个特殊的参数是针对 `RowBounds` 的，你可以参看上面的 **场景一** 和 **场景二**

**注：**不只有命名空间方式可以用RowBounds，使用接口的时候也可以增加RowBounds参数，例如：

```java
//这种情况下也会进行物理分页查询
List<Country> selectAll(RowBounds rowBounds);  
```

**注意：** 由于默认情况下的 `RowBounds` 无法获取查询总数，分页插件提供了一个继承自 `RowBounds` 的 `PageRowBounds`，这个对象中增加了 `total` 属性，执行分页查询后，可以从该属性得到查询总数。

##### 2).`PageHelper.startPage` 静态方法调用

除了 `PageHelper.startPage` 方法外，还提供了类似用法的 `PageHelper.offsetPage` 方法。

在你需要进行分页的 MyBatis 查询方法前调用 `PageHelper.startPage` 静态方法即可，紧跟在这个方法后的第一个**MyBatis 查询方法**会被进行分页。

**例一：**

```java
//获取第1页，10条内容，默认查询总数count
PageHelper.startPage(1, 10);
//紧跟着的第一个select方法会被分页
List<Country> list = countryMapper.selectIf(1);
assertEquals(2, list.get(0).getId());
assertEquals(10, list.size());
//分页时，实际返回的结果list类型是Page<E>，如果想取出分页信息，需要强制转换为Page<E>
assertEquals(182, ((Page) list).getTotal());
```

**例二：**

```java
//request: url?pageNum=1&pageSize=10
//支持 ServletRequest,Map,POJO 对象，需要配合 params 参数
PageHelper.startPage(request);
//紧跟着的第一个select方法会被分页
List<Country> list = countryMapper.selectIf(1);

//后面的不会被分页，除非再次调用PageHelper.startPage
List<Country> list2 = countryMapper.selectIf(null);
//list1
assertEquals(2, list.get(0).getId());
assertEquals(10, list.size());
//分页时，实际返回的结果list类型是Page<E>，如果想取出分页信息，需要强制转换为Page<E>，
//或者使用PageInfo类（下面的例子有介绍）
assertEquals(182, ((Page) list).getTotal());
//list2
assertEquals(1, list2.get(0).getId());
assertEquals(182, list2.size());
```

**例三，使用`PageInfo`的用法：**

```java
//获取第1页，10条内容，默认查询总数count
PageHelper.startPage(1, 10);
List<Country> list = countryMapper.selectAll();
//用PageInfo对结果进行包装
PageInfo page = new PageInfo(list);
//测试PageInfo全部属性
//PageInfo包含了非常全面的分页属性
assertEquals(1, page.getPageNum());
assertEquals(10, page.getPageSize());
assertEquals(1, page.getStartRow());
assertEquals(10, page.getEndRow());
assertEquals(183, page.getTotal());
assertEquals(19, page.getPages());
assertEquals(1, page.getFirstPage());
assertEquals(8, page.getLastPage());
assertEquals(true, page.isFirstPage());
assertEquals(false, page.isLastPage());
assertEquals(false, page.isHasPreviousPage());
assertEquals(true, page.isHasNextPage());
```

##### 3). 使用参数方式

想要使用参数方式，需要配置 `supportMethodsArguments` 参数为 `true`，同时要配置 `params` 参数。 例如下面的配置：

```xml
<plugins>
    <!-- com.github.pagehelper为PageHelper类所在包名 -->
    <plugin interceptor="com.github.pagehelper.PageInterceptor">
        <!-- 使用下面的方式配置参数，后面会有所有的参数介绍 -->
        <property name="supportMethodsArguments" value="true"/>
        <property name="params" value="pageNum=pageNumKey;pageSize=pageSizeKey;"/>
	</plugin>
</plugins>
```

在 MyBatis 方法中：

```java
List<Country> selectByPageNumSize(
        @Param("user") User user,
        @Param("pageNumKey") int pageNum,
        @Param("pageSizeKey") int pageSize);
```

当调用这个方法时，由于同时发现了 `pageNumKey` 和 `pageSizeKey` 参数，这个方法就会被分页。params 提供的几个参数都可以这样使用。

除了上面这种方式外，如果 User 对象中包含这两个参数值，也可以有下面的方法：

```java
List<Country> selectByPageNumSize(User user);
```

当从 User 中同时发现了 `pageNumKey` 和 `pageSizeKey` 参数，这个方法就会被分页。

注意：`pageNum` 和 `pageSize` 两个属性同时存在才会触发分页操作，在这个前提下，其他的分页参数才会生效。



[如何使用分页插件](https://pagehelper.github.io/docs/howtouse/)

#### SpringBoot中使用分页

[SpringBoot整合PageHelper做多条件分页查询](https://www.cnblogs.com/kelelipeng/p/11875574.html)





































